# คำอธิบายสถาปัตยกรรม API Relay

## ภาพรวม

API Relay เป็นระบบที่ออกแบบมาเพื่อเชื่อมต่อและถ่ายทอดข้อมูลระหว่างแอปพลิเคชันของคุณกับผู้ให้บริการ AI ต่างๆ เช่น ChatGPT และ Perplexity โดยผ่านส่วนขยายเบราว์เซอร์ ระบบนี้ทำงานในลักษณะของสะพานเชื่อมที่ช่วยให้คุณสามารถเข้าถึงความสามารถของ AI หลายๆ ตัวผ่านอินเทอร์เฟซเดียวกันได้

## สถาปัตยกรรมของระบบ

ระบบประกอบด้วยส่วนหลัก 3 ส่วน:

### 1. Server-side (เซิร์ฟเวอร์)

เป็นส่วนที่ทำงานบนคอมพิวเตอร์ของผู้ใช้ มีหน้าที่หลักดังนี้:

- **WebSocket Server** (`ws.ts`): รับและส่งข้อมูลระหว่างเบราว์เซอร์และแอปพลิเคชัน
- **HTTP API Server** (`server.ts`): ให้บริการ REST API สำหรับแอปพลิเคชันภายนอก
- **Queue Manager** (`queue.ts`): จัดการลำดับคำขอที่เข้ามาเพื่อประมวลผลตามลำดับ
- **Settings Manager** (`settings.ts`): จัดการการตั้งค่าต่างๆ ของระบบ

### 2. Browser Extension (ส่วนขยายเบราว์เซอร์)

เป็นส่วนที่ทำงานในเบราว์เซอร์ มีหน้าที่หลักดังนี้:

- **Background Script** (`background.js`): ทำงานในพื้นหลังเพื่อจัดการการสื่อสารระหว่างส่วนต่างๆ
- **Content Scripts** (`content.js`, `provider-utils.js`): ฉีดโค้ดเข้าไปในหน้าเว็บเพื่อโต้ตอบกับอินเทอร์เฟซของผู้ให้บริการ AI
- **Provider Scripts** (`providers/chatgpt.js`, `providers/perplexity.js`): โค้ดเฉพาะสำหรับแต่ละผู้ให้บริการ AI

### 3. External Services (บริการภายนอก)

คือผู้ให้บริการ AI ที่ระบบเชื่อมต่อด้วย:

- **ChatGPT**: บริการ AI จาก OpenAI
- **Perplexity**: บริการ AI ค้นหาและตอบคำถาม
- **อื่นๆ**: ผู้ให้บริการ AI ที่สามารถเพิ่มเติมได้

## ขั้นตอนการทำงาน

### 1. การเริ่มต้นระบบ

1. เมื่อผู้ใช้เริ่มต้นเซิร์ฟเวอร์ ระบบจะสร้าง WebSocket Server และ HTTP API Server
2. เซิร์ฟเวอร์จะรอการเชื่อมต่อจากส่วนขยายเบราว์เซอร์
3. เมื่อผู้ใช้เปิดเบราว์เซอร์และโหลดส่วนขยาย ส่วนขยายจะเชื่อมต่อกับเซิร์ฟเวอร์ผ่าน WebSocket
4. ส่วนขยายจะรอให้ผู้ใช้เปิดหน้าเว็บของผู้ให้บริการ AI (เช่น ChatGPT, Perplexity)
5. เมื่อตรวจพบหน้าเว็บที่รองรับ ส่วนขยายจะฉีด Content Script เข้าไปในหน้าเว็บ

### 2. การส่งคำขอไปยัง AI

1. แอปพลิเคชันของผู้ใช้ส่งคำขอมายัง HTTP API Server
2. เซิร์ฟเวอร์นำคำขอไปใส่ในคิว (Queue Manager)
3. เมื่อถึงคิว คำขอจะถูกส่งไปยังส่วนขยายผ่าน WebSocket
4. ส่วนขยายรับคำขอและส่งไปยัง Content Script ที่ทำงานในหน้าเว็บของผู้ให้บริการ AI
5. Content Script แปลงคำขอเป็นการกระทำในหน้าเว็บ:
   - ฉีดข้อความในช่องป้อนข้อความ
   - จำลองการคลิกปุ่มส่ง
   - เริ่มจับข้อมูลตอบกลับ

### 3. การรับและส่งข้อมูลตอบกลับ

1. Content Script จับข้อมูลตอบกลับจากผู้ให้บริการ AI ทั้งแบบสตรีมและแบบข้อมูลเต็ม
2. ข้อมูลจะถูกแปลงรูปแบบให้เข้ากันได้กับ API มาตรฐาน (เช่น OpenAI API format)
3. ข้อมูลถูกส่งกลับไปยังเซิร์ฟเวอร์ผ่าน WebSocket
4. เซิร์ฟเวอร์ส่งข้อมูลตอบกลับไปยังแอปพลิเคชันของผู้ใช้ผ่าน HTTP API

### 4. การจัดการหลายผู้ให้บริการ

ระบบรองรับผู้ให้บริการ AI หลายรายผ่านสถาปัตยกรรมแบบ Provider:

1. แต่ละผู้ให้บริการมี Provider Script ที่แยกกัน
2. Provider Script จัดการการโต้ตอบเฉพาะกับผู้ให้บริการนั้นๆ
3. แอปพลิเคชันสามารถระบุผู้ให้บริการที่ต้องการใช้งานผ่านพารามิเตอร์ในคำขอ
4. ระบบจะเลือก Provider ที่เหมาะสมเพื่อจัดการคำขอนั้นๆ

## รายละเอียดส่วนประกอบ

### WebSocket Server (`ws.ts`)

- จัดการการเชื่อมต่อแบบ real-time ระหว่างเซิร์ฟเวอร์และส่วนขยาย
- ส่งและรับข้อมูลในรูปแบบ JSON
- จัดการการเชื่อมต่อหลายรายการพร้อมกัน
- ตรวจสอบสถานะการเชื่อมต่อและจัดการกรณีที่เชื่อมต่อขาดหาย

### HTTP API Server (`server.ts`)

- ให้บริการ REST API สำหรับแอปพลิเคชันภายนอก
- รับคำขอและส่งต่อไปยัง Queue Manager
- ส่งข้อมูลตอบกลับในรูปแบบที่เข้ากันได้กับ OpenAI API
- รองรับทั้งแบบสตรีม (stream) และแบบข้อมูลเต็ม (completion)

### Queue Manager (`queue.ts`)

- จัดเก็บคำขอในลำดับที่เข้ามา (FIFO)
- ควบคุมจำนวนคำขอที่ประมวลผลพร้อมกัน
- จัดการลำดับความสำคัญของคำขอ
- จัดการ timeout สำหรับคำขอที่ใช้เวลานานเกินไป

### Provider Scripts (`providers/`)

- **ChatGPT Provider** (`chatgpt.js`):
  - จัดการการโต้ตอบกับหน้าเว็บ ChatGPT
  - จับข้อมูลจาก SSE (Server-Sent Events)
  - แปลงข้อมูลให้เข้ากับ OpenAI API format

- **Perplexity Provider** (`perplexity.js`):
  - จัดการการโต้ตอบกับหน้าเว็บ Perplexity
  - จัดการโมเดล AI ต่างๆ ของ Perplexity
  - แปลงข้อมูลให้เข้ากับ OpenAI API format

## การรักษาความปลอดภัย

ระบบมีมาตรการรักษาความปลอดภัยหลายระดับ:

1. **การจำกัดการเข้าถึง**: ส่วนขยายทำงานเฉพาะในหน้าเว็บที่กำหนดเท่านั้น
2. **การตรวจสอบคำขอ**: เซิร์ฟเวอร์ตรวจสอบคำขอที่เข้ามาเพื่อป้องกันการโจมตี
3. **การจัดการข้อมูล**: ข้อมูลที่ละเอียดอ่อนจะถูกจัดการอย่างปลอดภัย
4. **การควบคุมการเข้าถึง**: สามารถกำหนดสิทธิ์การเข้าถึงฟังก์ชันต่างๆ ได้

## การปรับปรุงและพัฒนาต่อ

ระบบได้รับการออกแบบให้ง่ายต่อการปรับปรุงและเพิ่มเติม:

1. **การเพิ่มผู้ให้บริการใหม่**: เพียงสร้าง Provider Script ใหม่
2. **การปรับแต่งฟังก์ชัน**: สามารถแก้ไขส่วนต่างๆ โดยไม่กระทบส่วนอื่น
3. **การเพิ่มคุณสมบัติ**: สามารถเพิ่มฟังก์ชันใหม่ๆ ได้ตามต้องการ
4. **การปรับปรุงประสิทธิภาพ**: สามารถปรับปรุงส่วนต่างๆ เพื่อเพิ่มความเร็วและประสิทธิภาพ

## ข้อจำกัดและข้อควรพิจารณา

1. **การพึ่งพาหน้าเว็บ**: ระบบต้องพึ่งพาโครงสร้างของหน้าเว็บผู้ให้บริการ AI ซึ่งอาจเปลี่ยนแปลงได้
2. **ความเร็วในการตอบสนอง**: ความเร็วขึ้นอยู่กับความเร็วของหน้าเว็บและเครือข่ายอินเทอร์เน็ต
3. **ความเสถียร**: ระบบอาจได้รับผลกระทบจากการเปลี่ยนแปลงของผู้ให้บริการ AI
4. **การใช้ทรัพยากร**: ส่วนขยายต้องใช้ทรัพยากรของเบราว์เซอร์และคอมพิวเตอร์

## สรุป

API Relay เป็นระบบที่ช่วยให้คุณสามารถเชื่อมต่อและใช้งานผู้ให้บริการ AI หลายรายผ่านอินเทอร์เฟซเดียวกัน ระบบใช้สถาปัตยกรรมที่ยืดหยุ่นและขยายได้ ทำให้ง่ายต่อการเพิ่มผู้ให้บริการใหม่ๆ และปรับแต่งการทำงานตามความต้องการของผู้ใช้