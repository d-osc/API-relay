# คู่มือการใช้งาน API Relay

## บทนำ

API Relay เป็นโปรแกรมที่ออกแบบมาเพื่อเชื่อมต่อและถ่ายทอดข้อมูลระหว่างผู้ให้บริการ AI ต่างๆ (เช่น ChatGPT, Perplexity) ผ่านส่วนขยาย (extension) ของเบราว์เซอร์ โปรแกรมนี้ทำงานในลักษณะของสะพานเชื่อม (bridge) ที่ช่วยให้คุณสามารถเข้าถึงความสามารถของ AI หลายๆ ตัวผ่านอินเทอร์เฟซเดียวกันได้

## โครงสร้างของโปรแกรม

### ส่วนประกอบหลัก

1. **Server-side** (`src/`)
   - `server.ts`: เซิร์ฟเวอร์หลักที่รับและส่งข้อมูล
   - `ws.ts`: จัดการการเชื่อมต่อ WebSocket
   - `queue.ts`: จัดการคิวของคำขอ
   - `settings.ts`: จัดการการตั้งค่า
   - `types.d.ts`: ประเภทข้อมูล TypeScript

2. **Client-side (Extension)** (`extension/`)
   - `manifest.json`: ไฟล์คอนฟิกของส่วนขยาย
   - `background.js`: สคริปต์ที่ทำงานในพื้นหลัง
   - `content.js`: สคริปต์ที่ฉีดเข้าไปในหน้าเว็บ
   - `provider-utils.js`: ฟังก์ชันที่ใช้ร่วมกัน
   - `providers/`: โฟลเดอร์ที่เก็บโปรไฟล์ของผู้ให้บริการ AI แต่ละราย

## วิธีการติดตั้งและเริ่มใช้งาน

### 1. การติดตั้งส่วนขยายในเบราว์เซอร์

1. เปิดเบราว์เซอร์ (เช่น Chrome, Firefox)
2. ไปที่หน้าจัดการส่วนขยาย (Extensions)
3. เปิดโหมด "นักพัฒนาซอฟต์แวร์" (Developer mode)
4. คลิก "โหลดส่วนขยายที่ไม่ได้บรรจุ" (Load unpacked)
5. เลือกโฟลเดอร์ `extension` ในโปรเจกต์

### 2. การเริ่มต้นเซิร์ฟเวอร์

```bash
# ติดตั้ง dependencies
npm install

# เริ่มต้นเซิร์ฟเวอร์
npm run dev
```

### 3. การเชื่อมต่อกับผู้ให้บริการ AI

1. เปิดหน้าเว็บของผู้ให้บริการ AI (เช่น ChatGPT, Perplexity)
2. ส่วนขยายจะทำงานอัตโนมัติเมื่อตรวจพบหน้าเว็บที่รองรับ
3. หากเชื่อมต่อสำเร็จ จะปรากฏข้อความยืนยันในคอนโซลของเบราว์เซอร์

## ฟังก์ชันหลักของโปรแกรม

### 1. การส่งข้อความ (Insert Text)

สามารถส่งข้อความไปยังหน้าเว็บของผู้ให้บริการ AI ได้โดย:

```javascript
window.postMessage({
  type: 'RELAY_INSERT_TEXT',
  id: 'unique-request-id',
  text: 'ข้อความที่ต้องการส่ง'
}, '*');
```

### 2. การคลิกปุ่มส่ง (Click Send)

สามารถสั่งให้คลิกปุ่มส่งข้อความได้โดย:

```javascript
window.postMessage({
  type: 'RELAY_CLICK_SEND',
  id: 'unique-request-id'
}, '*');
```

### 3. การจับข้อมูลตอบกลับ (Capture Response)

สามารถจับข้อมูลตอบกลับจาก AI ได้ในรูปแบบต่างๆ:

```javascript
// แบบสตรีม
window.postMessage({
  type: 'RELAY_CAPTURE_RESPONSE_V1_CHAT_COMPLETIONS_STREAM',
  id: 'unique-request-id',
  stream: true
}, '*');

// แบบข้อมูลเต็ม
window.postMessage({
  type: 'RELAY_CAPTURE_RESPONSE_V1_CHAT_COMPLETIONS',
  id: 'unique-request-id',
  stream: false
}, '*');
```

### 4. การตั้งค่าโมเดล (Set Model)

สามารถเลือกโมเดลที่ต้องการใช้ได้:

```javascript
window.postMessage({
  type: 'RELAY_MODEL',
  id: 'unique-request-id',
  model: 'gpt4' // หรือโมเดลอื่นๆ
}, '*');
```

## รูปแบบข้อมูลที่รองรับ

### V1 Chat Completions

รูปแบบที่เข้ากันได้กับ OpenAI API:

```javascript
{
  id: 'unique-id',
  created: timestamp,
  model: 'model-name',
  choices: [{
    index: 0,
    delta: {
      role: 'assistant',
      content: 'ข้อความตอบกลับ'
    }
  }]
}
```

### V1 Messages

รูปแบบที่เข้ากันได้กับ Anthropic API:

```javascript
{
  type: 'text_delta',
  text: 'ข้อความตอบกลับ'
}
```

## การจัดการข้อผิดพลาด

หากเกิดข้อผิดพลาดขึ้น โปรแกรมจะส่งข้อความแจ้ง:

```javascript
window.postMessage({
  type: 'RELAY_ERROR',
  id: 'request-id',
  error: 'ข้อความข้อผิดพลาด'
}, '*');
```

## การตั้งค่าขั้นสูง

สามารถปรับแต่งการทำงานของโปรแกรมผ่านไฟล์ `settings.ts`:

- การตั้งค่าพอร์ตเซิร์ฟเวอร์
- การกำหนดค่าหมดเวลา (timeout)
- การตั้งค่าจำนวนคิวสูงสุด
- การเลือกโมเดลเริ่มต้น

## ปัญหาที่พบบ่อยและวิธีแก้ไข

### 1. ส่วนขยายไม่ทำงาน

- ตรวจสอบว่าได้ติดตั้งส่วนขยายในโหมดนักพัฒนาซอฟต์แวร์แล้ว
- รีเฟรชหน้าเว็บที่ต้องการใช้งาน
- ตรวจสอบในคอนโซลของเบราว์เซอร์ว่ามีข้อความแสดงความผิดพลาดหรือไม่

### 2. เชื่อมต่อไม่ได้

- ตรวจสอบว่าเซิร์ฟเวอร์ทำงานอยู่
- ยืนยันว่าใช้พอร์ตที่ถูกต้อง
- ตรวจสอบไฟร์วอลล์และการตั้งค่าความปลอดภัย

### 3. ข้อมูลตอบกลับไม่ครบถ้วน

- เพิ่มค่า timeout ในการตั้งค่า
- ตรวจสอบความเร็วในการเชื่อมต่ออินเทอร์เน็ต
- ยืนยันว่าใช้โมเดลที่รองรับฟังก์ชันที่ต้องการ

## หมายเหตุด้านความปลอดภัย

- โปรแกรมนี้อ่านข้อมูลจากหน้าเว็บของบุคคลที่สามโดยตรง
- ข้อมูลที่ส่งผ่าน WebSocket ไม่ได้ถูกเข้ารหัสโดยค่าเริ่มต้น
- ควรใช้ในสภาพแวดล้อมที่ปลอดภัยและเชื่อถือได้เท่านั้น

## แหล่งข้อมูลเพิ่มเติม

- [คำอธิบายสถาปัตยกรรมของระบบ](./architecture-explanation-thai.md) - ศึกษาโครงสร้างและหลักการทำงานของระบบ
- [ผังการทำงานของระบบ](./flow-diagrams.md) - ดูแผนภาพการทำงานของระบบแบบละเอียด
- [เอกสารอ้างอิง API](./api-reference-thai.md) - คู่มือการใช้งาน API ครบถ้วน
- [คู่มือเริ่มต้นใช้งาน](./quick-start-thai.md) - เริ่มต้นใช้งาน API Relay อย่างรวดเร็ว